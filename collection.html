<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fee Collection - Fee Tracker</title>
    <!-- Security: Firebase onAuthStateChanged verifies staff/admin below -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --white: #ffffff; --text-dark: #1e293b; --text-gray: #64748b; --edit-mode-border: #f59e0b; --header-height: 70px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth !important; }
        
        body { background-color: #f8fafc; color: var(--text-dark); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        ul { list-style: none; }
        .hidden { display: none !important; }

        /* Public Page Consistent Header */
        header { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); position: sticky; top: 15px; z-index: 1000; 
            border: 1px solid #f1f5f9; height: var(--header-height); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04); 
            border-radius: 16px; margin: 15px auto; width: calc(100% - 30px); max-width: 1200px;
        }
        @media (max-width: 768px) { header { margin: 10px; width: calc(100% - 20px); border-radius: 12px; top: 10px; } }
        
        .nav-container { height: 100%; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
        
        .header-logo-box { width: 45px; height: 45px; flex-shrink: 0; z-index: 10; display: flex; align-items: center;}
        .header-logo-box img { max-height: 100%; max-width: 100%; border-radius: 8px; object-fit: contain; opacity: 0; transition: opacity 0.5s ease; }
        
        .header-center-box { position: absolute; left: 50%; transform: translateX(-50%); width: 55%; text-align: center; display: flex; flex-direction: column; justify-content: center; z-index: 1; }
        .header-center-box h1 { font-weight: 800; color: var(--primary); white-space: normal; line-height: 1.2; width: 100%; margin: 0 auto; font-size: 14px; word-wrap: break-word; }
        .header-center-box p { font-size: 10px; color: var(--text-gray); font-weight: 600; white-space: nowrap; opacity: 0.8; margin-top: 2px; }
        
        /* Animated Hamburger Only Menu */
        .mobile-toggle { display: block; color: var(--primary); cursor: pointer; padding: 5px 10px; z-index: 1001; position: relative; }
        .menu-icon-wrapper { width: 24px; height: 24px; position: relative; display: flex; align-items: center; justify-content: center; }
        .menu-icon-wrapper i { position: absolute; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 22px; }
        .icon-bars { opacity: 1; transform: rotate(0deg) scale(1); }
        .icon-close { opacity: 0; transform: rotate(-90deg) scale(0.5); }
        .active-toggle .icon-bars { opacity: 0; transform: rotate(90deg) scale(0.5); }
        .active-toggle .icon-close { opacity: 1; transform: rotate(0deg) scale(1); color: #ef4444; }

        .nav-menu { position: absolute; top: calc(100% + 15px); right: 0; width: 240px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); flex-direction: column; align-items: stretch; padding: 15px; gap: 8px; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); transform: translateY(-15px) scale(0.95); opacity: 0; pointer-events: none; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; transform-origin: top right; z-index: 900; display: flex; }
        .nav-menu.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        .nav-link { font-size: 14px; width: 100%; display: flex; align-items: center; gap: 10px; padding: 12px 15px; text-align: left; border-radius: 10px; font-weight: 600; color: var(--text-dark); transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #f8fafc; color: var(--accent); }
        
        .login-btn-nav { width: 100%; padding: 12px; background: #ef4444; color: var(--white); border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: transform 0.2s; border: none; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); display: flex; align-items: center; gap: 6px; justify-content: center; margin-top: 5px;}
        .login-btn-nav:hover { transform: translateY(-2px); }

        /* General UI Elements */
        main { flex-grow: 1; padding: 10px 15px; max-width: 1000px; margin: 0 auto; width: 100%; }
        .card { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; }
        .btn-primary { background-color: var(--accent); color: #ffffff; }
        .btn-primary:hover { background-color: #2563eb; }
        .table-header { background-color: #f8fafc; color: #4b5563; position: sticky; top: 0; z-index: 10; font-family: 'Poppins', sans-serif;}
        .popup-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        
        .month-paid { background-color: #10b981 !important; color: #ffffff !important; border-color: #059669 !important; cursor: not-allowed; }
        .month-editable { cursor: pointer !important; border: 2px solid var(--edit-mode-border) !important; }
        .edit-mode-active #fee-entry-card { border: 2px solid var(--edit-mode-border); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        
        input, select, textarea { background-color: #f8fafc; border: 1px solid #cbd5e1; color: #0f172a; transition: 0.2s; border-radius: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Public Page Consistent Footer */
        .footer { width:100%; padding: 20px 15px 15px; text-align:center; margin-top: auto; background: #ffffff; border-top: 1px solid #e2e8f0; }
        .follow-title { color:var(--primary); font-size:11px; letter-spacing:1px; font-weight:800; margin-bottom:10px; font-family: sans-serif; }
        .socials { display:flex; justify-content:center; gap:8px; margin-bottom:15px; }
        .socials a { width:32px; height:32px; background: #f8fafc; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--text-gray); font-size:14px; text-decoration:none; transition: 0.3s; border: 1px solid #e2e8f0;}
        .socials a:hover { background: var(--accent); color: white; transform: translateY(-2px); border-color: var(--accent);}
        .corporate { font-size:12px; color:var(--text-gray); margin-bottom:12px; display: flex; justify-content: center; gap: 10px; align-items: center; font-weight: 600; flex-wrap: wrap; }
        .corporate a { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; transition: background 0.2s; background: #f8fafc; border: 1px solid #e2e8f0;}
        .corporate a:hover { background: #eff6ff; color: var(--accent); border-color: #bfdbfe;}
        .corporate i { color: var(--accent); font-size: 12px;}
        .divider { width:40px; height:3px; background:var(--accent); margin:0 auto 10px; border-radius: 2px;}
        .copy { color:#64748b; font-size:10px; font-weight: 600; }
        .powered { margin-top: 6px; font-size: 11px; font-weight: 700; color: #94a3b8; }
        .powered a { color: #64748b; text-decoration: underline; text-underline-offset: 2px; transition: color 0.2s; }
        .powered a:hover { color: var(--accent); }
    </style>
</head>
<body class="antialiased text-gray-800">
    
    <!-- Unified Header -->
    <header>
        <div class="nav-container">
            <div class="header-logo-box">
                <img id="header-logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
            </div>
            
            <div class="header-center-box">
                <h1 id="header-title">Fee Collection</h1>
                <p id="header-subtitle" class="hidden"><span id="header-regno"></span> <span id="header-sep" class="mx-1 hidden">|</span> <span id="header-place"></span></p>
            </div>

            <!-- Hamburger Toggle Icon -->
            <div class="mobile-toggle" id="mobile-menu-btn">
                <div class="menu-icon-wrapper">
                    <i class="fas fa-bars icon-bars"></i>
                    <i class="fas fa-times icon-close"></i>
                </div>
            </div>
            
            <!-- Unified Nav Menu -->
            <ul class="nav-menu">
                <div class="bg-blue-50 border border-blue-100 p-3 rounded-lg shadow-sm mb-2 text-center">
                    <div class="text-[10px] text-blue-500 font-bold uppercase">Logged in as</div>
                    <div id="staff-name-display" class="text-blue-800 font-bold truncate text-sm">Loading...</div>
                </div>
                
                <li><a href="#dashboard" class="nav-link tab-link active" data-target="dashboard-page"><i class="fas fa-tachometer-alt text-lg w-6"></i> Dashboard</a></li>
                <li><a href="#home" class="nav-link tab-link" data-target="home-page"><i class="fas fa-edit text-lg w-6"></i> Fee Entry</a></li>
                <li><a href="#history" class="nav-link tab-link" data-target="history-page"><i class="fas fa-history text-lg w-6"></i> History</a></li>
                <li><a href="#fee" class="nav-link tab-link" data-target="fee-page"><i class="fas fa-list text-lg w-6"></i> Fee Status</a></li>
                <li><a href="#monthly" class="nav-link tab-link" data-target="monthly-collected-page"><i class="fas fa-chart-bar text-lg w-6"></i> Monthly Report</a></li>
                <li><a href="#students" class="nav-link tab-link" data-target="students-page"><i class="fas fa-user-graduate text-lg w-6"></i> Students</a></li>
                
                <div class="border-t border-gray-100 my-1"></div>
                <li><a href="#" id="open-profile-btn" class="nav-link text-gray-600"><i class="fas fa-user-circle text-lg w-6"></i> My Profile</a></li>
                <li><button id="logout-btn" class="login-btn-nav"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
            </ul>
        </div>
    </header>

    <main id="app">
        <div id="page-content">
            
            <!-- 1. Dashboard Page -->
            <section id="dashboard-page" class="page-content">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 px-2">Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden flex justify-between items-center">
                        <div class="relative z-10">
                            <h2 class="text-xs font-bold text-blue-100 uppercase tracking-wider mb-1">Today's Collection</h2>
                            <div class="text-3xl font-bold font-mono">₹<span id="dash-today-amt">0</span></div>
                        </div>
                        <i class="fas fa-calendar-day text-5xl opacity-20 transform translate-x-2 absolute right-4"></i>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-600 to-green-500 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden flex justify-between items-center">
                        <div class="relative z-10">
                            <h2 class="text-xs font-bold text-green-100 uppercase tracking-wider mb-1">This Month</h2>
                            <div class="text-3xl font-bold font-mono">₹<span id="dash-month-amt">0</span></div>
                        </div>
                        <i class="fas fa-chart-line text-5xl opacity-20 transform translate-x-2 absolute right-4"></i>
                    </div>

                    <div class="bg-white border border-gray-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl"><i class="fas fa-users"></i></div>
                        <div>
                            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Total Students</h2>
                            <div class="text-2xl font-bold text-gray-800" id="dash-students-count">0</div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center text-2xl"><i class="fas fa-file-invoice"></i></div>
                        <div>
                            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Receipts Today</h2>
                            <div class="text-2xl font-bold text-gray-800" id="dash-today-receipts">0</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button onclick="document.querySelector('.tab-link[data-target=\'home-page\']').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-md transition inline-flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> New Fee Entry
                    </button>
                </div>
            </section>

            <!-- 2. Fee Entry Page -->
            <section id="home-page" class="page-content hidden">
                <div id="fee-entry-card" class="card p-5 mb-6 shadow-sm transition-all duration-300">
                    <div class="flex justify-between items-center mb-5 border-b pb-2"><h2 id="fee-entry-title" class="text-xl font-bold text-gray-800">Fee Entry</h2></div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-semibold mb-1 text-gray-700">Class</label><select id="entry-class" class="w-full p-2.5"></select></div>
                            <div><label class="block text-sm font-semibold mb-1 text-gray-700">Gender</label><select id="entry-gender" class="w-full p-2.5"><option value="Male">Male</option><option value="Female">Female</option></select></div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Student</label>
                            <div class="relative" id="student-combobox-container">
                                <input type="text" id="entry-student-input" class="w-full p-2.5 pr-10" placeholder="Type name or Adm No...">
                                <div id="student-suggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl hidden max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1 text-gray-700 flex justify-between">
                                    <span>Receipt No. <span id="receipt-req-star" class="text-red-500 font-bold hidden">*</span></span>
                                    <span class="text-[10px] text-gray-400 font-normal">(Auto)</span>
                                </label>
                                <input type="number" id="entry-receipt" class="w-full p-2.5 font-mono text-lg font-bold text-blue-700" placeholder="Number">
                            </div>
                            <div><label class="block text-sm font-semibold mb-1 text-gray-700">Date</label><input type="date" id="entry-date" class="w-full p-2.5"></div>
                        </div>
                    </div>
                    
                    <div class="mt-5">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Fee Items</label>
                        <div id="fee-item-selection-container" class="grid grid-cols-3 gap-2 mt-2">
                            <div class="col-span-3 text-center text-xs font-semibold text-gray-400 py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">Search and select a student first</div>
                        </div>
                    </div>
                    
                    <div class="mt-5"><label class="block text-sm font-semibold mb-1 text-gray-700">Description (Optional)</label><textarea id="entry-description" rows="2" class="w-full p-2.5"></textarea></div>
                    <div class="mt-6 pt-5 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="w-full sm:w-auto">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Total Amount (₹)</label>
                            <input type="number" id="total-amount" class="p-2.5 w-full sm:w-32 font-mono text-xl font-bold text-green-700 bg-green-50 border border-green-300 rounded-lg text-center focus:ring-2 focus:ring-green-400 focus:outline-none" value="0">
                        </div>
                        <div id="action-buttons-container" class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                            <button id="cancel-edit-btn" class="bg-gray-200 text-gray-800 font-bold py-2.5 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition hidden flex-grow sm:flex-grow-0">Cancel</button>
                            <button id="update-fee-btn" class="bg-amber-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-md hover:bg-amber-600 transition hidden flex-grow sm:flex-grow-0">Update</button>
                            <button id="save-fee-btn" class="btn-primary font-bold py-2.5 px-8 rounded-lg shadow-md text-lg w-full sm:w-auto">Save</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Fee Status Page -->
            <section id="fee-page" class="page-content hidden">
                <div class="card p-4 mb-5 shadow-sm">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-semibold mb-1 text-gray-700">Class</label><select id="filter-class" class="w-full p-2.5"><option value="all">All Classes</option></select></div>
                        <div><label class="block text-sm font-semibold mb-1 text-gray-700">Gender</label><select id="filter-gender" class="w-full p-2.5"><option value="all">All Genders</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                    </div>
                </div>
                <div class="card p-0 shadow-sm overflow-hidden">
                    <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50">
                         <h2 id="fee-status-title-header" class="text-lg font-bold text-gray-800">Fee Status</h2>
                         <button id="fee-download-pdf-btn" class="py-1.5 px-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow flex items-center gap-2 text-sm transition"><i class="fas fa-file-pdf"></i> Download PDF</button>
                    </div>
                    <div id="fee-table-container" class="overflow-x-auto p-4 custom-scroll max-h-[70vh]"></div>
                </div>
            </section>

            <!-- 4. History Page -->
            <section id="history-page" class="page-content hidden">
                <div class="card p-0 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-3">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <h2 class="text-lg font-bold text-gray-800">Payment History</h2>
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded" id="history-count-badge">Loading...</span>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <!-- Search Bar -->
                            <div class="relative w-full sm:w-48">
                                <input type="text" id="history-search-input" placeholder="Search history..." class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm bg-white outline-none focus:border-blue-500">
                                <i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            </div>
                            
                            <!-- Admin Filter -->
                            <select id="history-staff-filter" class="p-2 border border-gray-300 rounded-lg text-sm bg-white hidden w-full sm:w-48 outline-none focus:border-blue-500">
                                <option value="all">All Collections</option>
                            </select>
                        </div>
                    </div>
                    <div id="history-content-container" class="overflow-x-auto custom-scroll max-h-[65vh] p-4 relative">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="table-header">
                                <tr><th class="p-3">Rcpt</th><th class="p-3">Date</th><th class="p-3">Student</th><th class="p-3">Collected By</th><th class="p-3 text-center">Items</th><th class="p-3">Total</th><th class="p-3 text-center">Actions</th></tr>
                            </thead>
                            <tbody id="history-content-tbody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                        <div id="history-loading-indicator" class="hidden text-center py-4 text-gray-500 font-bold text-sm">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Loading more...
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Monthly Collected Page -->
            <section id="monthly-collected-page" class="page-content hidden">
                 <div class="card p-5 shadow-sm">
                     <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Monthly Report</h2>
                     <div class="relative mb-5">
                        <input type="text" id="monthly-collected-search-input" placeholder="Search by name, adm no or receipt..." class="w-full p-3 pl-10 border rounded-lg shadow-sm bg-gray-50">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                     <div id="monthly-collected-container" class="space-y-4"></div>
                 </div>
            </section>

            <!-- 6. Student Info Page -->
            <section id="students-page" class="page-content hidden">
                <div class="card p-4 shadow-sm mb-5">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Student Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Class</label><select id="stu-info-class" class="w-full p-2.5 mt-1"><option value="">-- Select --</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Gender</label><select id="stu-info-gender" class="w-full p-2.5 mt-1"><option value="all">All</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Search</label><div class="relative mt-1"><input type="text" id="stu-info-search" placeholder="Name or Adm No..." class="w-full p-2.5 pl-8"><i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i></div></div>
                    </div>
                </div>
                <div id="stu-info-empty" class="text-center py-8 bg-gray-50 rounded-xl border border-dashed border-gray-300 text-gray-500">Select a Class to view students.</div>
                <div id="stu-info-list" class="space-y-2 hidden"></div>
            </section>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="follow-title">FOLLOW US</div>
        <div class="socials">
            <a href="#" id="link-youtube" target="_blank" class="hidden"><i class="fa-brands fa-youtube"></i></a>
            <a href="#" id="link-telegram" target="_blank" class="hidden"><i class="fa-brands fa-telegram-plane"></i></a>
            <a href="#" id="link-instagram" target="_blank" class="hidden"><i class="fa-brands fa-instagram"></i></a>
            <a href="#" id="link-whatsapp" target="_blank" class="hidden"><i class="fa-brands fa-whatsapp"></i></a>
            <a href="#" id="link-facebook" target="_blank" class="hidden"><i class="fa-brands fa-facebook-f"></i></a>
        </div>
        <div class="corporate">
           <a href="#" id="footer-email-link"><i class="fas fa-envelope"></i> <span id="footer-email">Email</span></a>
           <a href="#" id="footer-phone-link"><i class="fas fa-phone"></i> <span id="footer-phone">Phone</span></a>
        </div>
        <div class="divider"></div>
        <div class="copy">© <span id="footer-inst-name">Institution Name</span>. All Rights Reserved.</div>
        <div class="powered">Developed by <a href="https://www.instagram.com/muhammed_sanjide_p" target="_blank">HADI MAHIRI FAIZY</a></div>
    </footer>

    <!-- Modals -->
    <div id="confirm-popup" class="fixed inset-0 popup-overlay items-center justify-center hidden z-50 px-4">
        <div class="card rounded-xl shadow-2xl p-6 w-full max-w-md mx-auto">
            <h3 class="text-xl font-bold mb-4 text-gray-900 border-b pb-2" id="confirm-title">Confirm</h3>
            <div id="confirm-message" class="mb-6 text-left max-h-60 overflow-y-auto text-gray-700 text-sm"></div>
            <div class="flex justify-end gap-3"><button id="confirm-cancel" class="px-5 py-2.5 rounded-lg bg-gray-200 font-semibold">Cancel</button><button id="confirm-ok" class="btn-primary px-5 py-2.5 rounded-lg font-bold shadow-md">OK</button></div>
        </div>
    </div>

    <!-- My Profile Popup (Staff) -->
    <div id="my-profile-popup" class="fixed inset-0 popup-overlay items-center justify-center hidden z-50 px-4">
        <div class="card rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto relative text-center">
            <button id="close-my-profile-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4 text-gray-900 border-b pb-2 text-left">My Profile</h3>
            
            <img id="my-prof-img" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-blue-50 shadow-md mb-4">
            <h2 id="my-prof-name" class="text-2xl font-bold text-gray-800">Name</h2>
            <p id="my-prof-role" class="text-sm font-bold text-blue-600 uppercase tracking-wide mb-5">Role</p>

            <div class="space-y-3 text-left bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="flex justify-between items-center border-b pb-2"><span class="text-xs text-gray-500 font-bold uppercase"><i class="fas fa-envelope mr-1"></i> Email</span><span class="font-medium text-sm text-gray-800" id="my-prof-email"></span></div>
                <div class="flex justify-between items-center border-b pb-2"><span class="text-xs text-gray-500 font-bold uppercase"><i class="fas fa-phone mr-1"></i> Phone</span><span class="font-medium text-sm text-gray-800" id="my-prof-phone"></span></div>
                <div class="flex justify-between items-center border-b pb-2"><span class="text-xs text-gray-500 font-bold uppercase"><i class="fas fa-id-card mr-1"></i> MSR No</span><span class="font-medium text-sm text-gray-800" id="my-prof-msr"></span></div>
                <div class="flex justify-between items-start"><span class="text-xs text-gray-500 font-bold uppercase"><i class="fas fa-map-marker-alt mr-1"></i> Address</span><span class="font-medium text-sm text-gray-800 text-right max-w-[60%]" id="my-prof-addr"></span></div>
            </div>
        </div>
    </div>

    <!-- Student Profile Popup -->
    <div id="student-profile-popup" class="fixed inset-0 popup-overlay items-center justify-center hidden z-50 px-4">
        <div class="card rounded-2xl shadow-2xl p-6 w-full max-w-md mx-auto relative">
            <button id="close-profile-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4 text-gray-900 border-b pb-2">Student Profile</h3>
            
            <div class="space-y-3 mb-6">
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Name</span><span class="font-bold text-gray-800" id="prof-name"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Class</span><span class="font-bold text-gray-800" id="prof-class"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Gender</span><span class="font-bold text-gray-800" id="prof-gender"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Adm. No</span><span class="font-bold font-mono text-gray-800" id="prof-adm"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">UID/ID</span><span class="font-bold text-gray-800" id="prof-uid"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Father's Name</span><span class="font-bold text-gray-800" id="prof-father"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Address</span><span class="font-bold text-gray-800 text-right max-w-[60%]" id="prof-addr"></span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span class="text-sm text-gray-500 font-medium">Fee Concession</span><span class="font-bold text-green-600" id="prof-conc"></span></div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center">
                <p class="text-xs text-blue-600 font-bold uppercase tracking-wider mb-2">Registered Mobile</p>
                <div class="text-xl font-bold font-mono text-gray-800 mb-3" id="prof-mobile"></div>
                <a href="#" id="prof-call-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-md inline-flex items-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-phone-alt"></i> Call Student
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Integration & UI Logic -->
    <script type="module">
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, onSnapshot, collection, getDocs, writeBatch, setDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { db, auth, BASE_PATH } from './js/firebase-config.js';

        // --- GLOBAL STATE ---
        let isCurrentAdmin = false; 
        let currentUserEmail = '';
        let students = [], allPayments = [], classes = [], studentGroups = [], feeItems = [], allStaff = [];
        let defaultFee = 200, feeStatusTitle = '', defaultReceiptMandatory = false;
        let isEditMode = false, editingPaymentGroup = {}, selectedStudentId = null;

        // History Pagination State
        let sortedHistoryList = [];
        let historyDisplayedCount = 0;
        const INITIAL_LOAD = 30;
        const LOAD_MORE = 10;

        // --- AUTH & LOGOUT ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                if (isCurrentAdmin) { window.location.href = 'admin.html'; } 
                else { localStorage.removeItem('staff_logged_in'); localStorage.removeItem('staff_name'); window.location.href = 'index.html'; }
            });
        });

        // --- UI TOGGLES (Hamburger & Modals) ---
        const mobileToggle = document.getElementById('mobile-menu-btn');
        const toggleIcon = mobileToggle.querySelector('i');
        const navMenu = document.querySelector('.nav-menu');

        const closeMenu = () => {
            navMenu.classList.remove('active'); 
            toggleIcon.classList.remove('fa-times');
            toggleIcon.classList.add('fa-bars');
            toggleIcon.style.transform = 'rotate(0deg)';
        };

        mobileToggle.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            navMenu.classList.toggle('active'); 
            if(navMenu.classList.contains('active')) {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-times');
                toggleIcon.style.transform = 'rotate(90deg)';
            } else {
                closeMenu();
            }
        });

        document.addEventListener('click', (e) => { 
            if (!navMenu.contains(e.target) && !mobileToggle.contains(e.target)) closeMenu(); 
        });

        document.getElementById('confirm-cancel').addEventListener('click', () => {
            document.getElementById('confirm-popup').classList.add('hidden');
        });
        document.getElementById('close-profile-btn').addEventListener('click', () => { 
            document.getElementById('student-profile-popup').classList.add('hidden'); 
        });
        document.getElementById('close-my-profile-btn').addEventListener('click', () => { 
            document.getElementById('my-profile-popup').classList.add('hidden'); 
        });
        document.getElementById('open-profile-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if(isCurrentAdmin) {
                document.getElementById('my-prof-name').textContent = "Administrator";
                document.getElementById('my-prof-role').textContent = "Master Admin";
                document.getElementById('my-prof-email').textContent = currentUserEmail || 'admin@institute.com';
                document.getElementById('my-prof-phone').textContent = "-";
                document.getElementById('my-prof-msr').textContent = "-";
                document.getElementById('my-prof-addr').textContent = "System Administrator Account";
                document.getElementById('my-prof-img').src = "logo.png";
            } else {
                const myData = allStaff.find(s => s.email === currentUserEmail);
                if(myData) {
                    document.getElementById('my-prof-name').textContent = myData.name || 'Staff';
                    document.getElementById('my-prof-role').textContent = myData.role || myData.type;
                    document.getElementById('my-prof-email').textContent = myData.email || '-';
                    document.getElementById('my-prof-phone').textContent = myData.phone || '-';
                    document.getElementById('my-prof-msr').textContent = myData.msr || '-';
                    document.getElementById('my-prof-addr').textContent = myData.address || '-';
                    document.getElementById('my-prof-img').src = myData.photo || "https://via.placeholder.com/150";
                }
            }
            document.getElementById('my-profile-popup').classList.remove('hidden');
            document.getElementById('my-profile-popup').classList.add('flex');
            closeMenu();
        });

        // --- TAB SWITCHING LOGIC (CORE FIX) ---
        const links = document.querySelectorAll('.tab-link');
        const pages = document.querySelectorAll('.page-content');
        
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                const targetId = link.getAttribute('data-target');
                if(!targetId) return;
                
                e.preventDefault();
                links.forEach(l => l.classList.remove('active')); 
                link.classList.add('active');
                
                pages.forEach(p => p.classList.add('hidden'));
                
                const targetSection = document.getElementById(targetId);
                if (targetSection) targetSection.classList.remove('hidden');
                
                closeMenu();
                window.scrollTo(0,0);

                // TRIGER RENDER FUNCTIONS ON TAB SWITCH
                if (targetId === 'history-page') prepareHistoryData();
                if (targetId === 'fee-page') renderFeeTable();
                if (targetId === 'students-page') renderStudentInfoList();
                if (targetId === 'home-page') exitEditMode();
                if (targetId === 'dashboard-page') updateDashboardMetrics();
                if (targetId === 'monthly-collected-page') renderMonthlyCollectedPage(document.getElementById('monthly-collected-search-input').value);
            });
        });

        function fitText(elementId) {
            const el = document.getElementById(elementId);
            if(!el) return;
            const parent = el.parentElement;
            el.style.fontSize = ''; 
            let fontSize = parseInt(window.getComputedStyle(el).fontSize);
            el.style.whiteSpace = 'nowrap';
            while (el.scrollWidth > parent.clientWidth && fontSize > 12) {
                fontSize -= 1;
                el.style.fontSize = fontSize + 'px';
            }
        }
        window.addEventListener('resize', () => { fitText('header-title'); });

        // --- HELPER FUNCTIONS ---
        const getStudentById = (id) => students.find(s => s.id === id);
        
        const getStaffName = (email, savedName) => {
            if (savedName && savedName !== email) return savedName;
            if (!email) return 'Admin';
            const st = allStaff.find(s => s.email === email);
            if (st && st.name) return st.name;
            if (email === currentUserEmail && isCurrentAdmin) return 'Administrator';
            return email;
        };

        const getVisiblePayments = () => {
            if(isCurrentAdmin) return allPayments;
            return allPayments.filter(p => p.collectedBy === currentUserEmail);
        };

        // --- DASHBOARD RENDER ---
        const updateDashboardMetrics = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentMonthStr = todayStr.substring(0, 7);
            const myPays = getVisiblePayments();

            let todayTotal = 0, monthTotal = 0;
            const todayReceipts = new Set();

            myPays.forEach(p => {
                const amt = parseFloat(p.amount) || 0;
                if(p.paymentDate === todayStr) {
                    todayTotal += amt;
                    todayReceipts.add(p.transactionId || p.receiptNo);
                }
                if(p.paymentDate && p.paymentDate.substring(0,7) === currentMonthStr) {
                    monthTotal += amt;
                }
            });

            document.getElementById('dash-today-amt').textContent = todayTotal.toFixed(0);
            document.getElementById('dash-month-amt').textContent = monthTotal.toFixed(0);
            document.getElementById('dash-today-receipts').textContent = todayReceipts.size;
            document.getElementById('dash-students-count').textContent = students.length;
        };

        // --- FEE ENTRY & LOGIC ---
        const populateClassDropdowns = () => {
            classes = [...new Set(students.map(s => s.class))].sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
            const opts = classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('filter-class').innerHTML = `<option value="all">All Classes</option>` + opts;
            document.getElementById('entry-class').innerHTML = opts;
            document.getElementById('stu-info-class').innerHTML = `<option value="">-- Select --</option>` + opts;
        };

        const resetStudentSelection = () => { selectedStudentId = null; document.getElementById('entry-student-input').value = ''; document.getElementById('student-suggestions').classList.add('hidden'); populateFeeItemSelection(); };
        document.getElementById('entry-class').addEventListener('change', resetStudentSelection);
        document.getElementById('entry-gender').addEventListener('change', resetStudentSelection);
        document.getElementById('filter-class').addEventListener('change', () => renderFeeTable());
        document.getElementById('filter-gender').addEventListener('change', () => renderFeeTable());

        const populateStudentSuggestions = (searchTerm = '') => {
            const cls = document.getElementById('entry-class').value, gen = document.getElementById('entry-gender').value, lSugg = document.getElementById('student-suggestions');
            const fil = students.filter(s => s.class === cls && s.gender === gen && (s.name.toLowerCase().includes(searchTerm.toLowerCase()) || (s.adm && s.adm.toLowerCase().includes(searchTerm.toLowerCase())))).sort((a,b)=>a.name.localeCompare(b.name));
            lSugg.innerHTML = '';
            if(fil.length > 0) {
                fil.forEach(s => {
                    const d = document.createElement('div'); d.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b text-sm font-medium flex justify-between'; 
                    d.innerHTML = `<span>${s.name}</span><span class="text-xs text-gray-500 font-mono">Adm: ${s.adm||'-'}</span>`;
                    d.onclick = () => { selectedStudentId = s.id; document.getElementById('entry-student-input').value = `${s.name} (Adm: ${s.adm||'-'})`; lSugg.classList.add('hidden'); populateFeeItemSelection(); };
                    lSugg.appendChild(d);
                });
                lSugg.classList.remove('hidden');
            } else lSugg.classList.add('hidden');
        };
        document.getElementById('entry-student-input').addEventListener('focus', () => populateStudentSuggestions(''));
        document.getElementById('entry-student-input').addEventListener('input', e => populateStudentSuggestions(e.target.value));
        document.addEventListener('click', e => { if(!document.getElementById('student-combobox-container').contains(e.target)) document.getElementById('student-suggestions').classList.add('hidden'); });

        const getNextReceiptNoForStaff = () => {
            const myPays = allPayments.filter(p => p.collectedBy === currentUserEmail && p.receiptNo);
            if (myPays.length === 0) return ''; 
            const validPays = myPays.map(p => parseInt(p.receiptNo)).filter(n => !isNaN(n));
            if(validPays.length === 0) return '';
            return Math.max(...validPays) + 1;
        };

        const checkReceiptMandatory = () => {
            let isReq = false;
            document.querySelectorAll('.fee-item-checkbox:checked').forEach(cb => {
                const type = cb.dataset.itemType, key = cb.dataset.itemKey;
                if(type === 'custom') { const item = feeItems.find(i=>i.key === key); if(item && item.isReceiptMandatory) isReq = true; }
                else if(type === 'month') { if(defaultReceiptMandatory) isReq = true; }
            });
            document.getElementById('receipt-req-star').classList.toggle('hidden', !isReq);
            return isReq;
        };

        const updateTotalAmount = () => {
            let total = 0;
            const st = getStudentById(selectedStudentId);
            let baseFee = defaultFee;
            if(st) {
                const group = studentGroups.find(g => g.memberIds.includes(st.id));
                if(st.concessionFee !== undefined && st.concessionFee !== null && st.concessionFee !== "") baseFee = parseFloat(st.concessionFee);
                else if(group && group.fee > 0) baseFee = group.fee;
            }

            document.querySelectorAll('.fee-item-checkbox[data-item-type="month"]:checked:not(:disabled)').forEach(() => total += baseFee);
            document.querySelectorAll('.fee-item-checkbox[data-item-type="custom"]:checked:not(:disabled)').forEach(cb => { total += parseFloat(cb.closest('.relative').querySelector('.custom-fee-amount-input').value) || 0; });
            document.getElementById('total-amount').value = total;
            checkReceiptMandatory();
        };

        const populateFeeItemSelection = () => {
            const st = getStudentById(selectedStudentId);
            const container = document.getElementById('fee-item-selection-container');
            
            if(!st) {
                container.innerHTML = '<div class="col-span-3 text-center text-xs font-semibold text-gray-400 py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">Search and select a student first</div>';
                document.getElementById('total-amount').value = 0;
                return;
            }
            
            const visibleItems = feeItems.filter(i => {
                if(i.isVisible === false) return false;
                if(i.type === 'custom' && st) {
                    if(i.scope === 'specific' && i.targetClass !== st.class) return false;
                }
                return true;
            });

            if (visibleItems.length === 0) {
                 container.innerHTML = '<div class="col-span-3 text-center text-xs font-semibold text-gray-400 py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">No fee items available</div>';
                 document.getElementById('total-amount').value = 0;
                 return;
            }

            container.innerHTML = visibleItems.map(item => {
                let defaultAmt = '';
                if(item.type === 'custom' && st) {
                    if(item.scope === 'global') defaultAmt = item.amount || '';
                    else if(item.scope === 'class-wise' && item.classValues) defaultAmt = item.classValues[st.class] || '';
                    else if(item.scope === 'specific') defaultAmt = item.amount || '';
                }
                
                return `
                <div class="relative"><input type="checkbox" id="item-${item.key}" data-item-key="${item.key}" data-item-type="${item.type||'month'}" class="fee-item-checkbox peer sr-only">
                <label for="item-${item.key}" class="block py-2 px-1 text-[11px] sm:text-xs font-semibold border rounded-lg cursor-pointer text-center bg-white peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 shadow-sm transition truncate" title="${item.name}">${item.name}</label>
                ${item.type === 'custom' ? `<input type="number" class="custom-fee-amount-input hidden w-full mt-1.5 p-1.5 text-xs font-medium border rounded-md shadow-sm text-center bg-gray-50" placeholder="₹ Amount" value="${defaultAmt}">` : ''}</div>
                `;
            }).join('');

            if(st) {
                document.querySelectorAll('.fee-item-checkbox').forEach(cb => {
                    const pay = allPayments.find(p => p.studentId === st.id && p.itemKey === cb.dataset.itemKey);
                    cb.checked = false; cb.disabled = !!pay;
                    if(pay) { cb.checked = true; cb.nextElementSibling.classList.add('month-paid'); }
                });
            }
            updateTotalAmount();
        };

        document.getElementById('fee-item-selection-container').addEventListener('input', e => { if(e.target.classList.contains('custom-fee-amount-input') || e.target.classList.contains('fee-item-checkbox')) updateTotalAmount(); });
        document.getElementById('fee-item-selection-container').addEventListener('change', e => { if(e.target.classList.contains('fee-item-checkbox') && e.target.dataset.itemType === 'custom') { const input = e.target.closest('.relative').querySelector('.custom-fee-amount-input'); if(input) { input.classList.toggle('hidden', !e.target.checked); if(!e.target.checked) input.value = ''; } } });

        const setupFeeEntryUI = () => {
            document.getElementById('fee-entry-title').textContent = "Fee Entry";
            document.getElementById('save-fee-btn').classList.remove('hidden'); document.getElementById('cancel-edit-btn').classList.add('hidden'); document.getElementById('update-fee-btn').classList.add('hidden');
            
            document.getElementById('entry-receipt').value = getNextReceiptNoForStaff(); 
            document.getElementById('entry-description').value = ''; 
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            populateFeeItemSelection();
        };

        const exitEditMode = () => { isEditMode = false; editingPaymentGroup = {}; resetStudentSelection(); setupFeeEntryUI(); };
        document.getElementById('cancel-edit-btn').addEventListener('click', exitEditMode);

        const startEditingPayment = (studentId, txnId) => {
            const student = getStudentById(studentId); if(!student) return;
            document.querySelector('.nav-link[data-target="home-page"]').click();
            document.getElementById('entry-class').value = student.class; document.getElementById('entry-gender').value = student.gender;
            selectedStudentId = student.id; document.getElementById('entry-student-input').value = `${student.name} (Adm: ${student.adm||'-'})`; document.getElementById('student-suggestions').classList.add('hidden');
            
            isEditMode = true; 
            document.getElementById('fee-entry-title').textContent = "Edit Payment";
            document.getElementById('save-fee-btn').classList.add('hidden'); document.getElementById('cancel-edit-btn').classList.remove('hidden'); document.getElementById('update-fee-btn').classList.remove('hidden');
            
            populateFeeItemSelection();
            
            const grp = allPayments.filter(p => p.transactionId === txnId || (!p.transactionId && p.receiptNo.toString() === txnId));
            if(grp.length === 0) return;

            editingPaymentGroup = { txnId, itemKeys: new Set(grp.map(p=>p.itemKey)) };
            
            document.getElementById('entry-receipt').value = grp[0].receiptNo || ''; document.getElementById('entry-date').value = grp[0].paymentDate;
            document.getElementById('entry-description').value = grp[0].description || ''; document.getElementById('total-amount').value = grp.reduce((s,p)=>s+p.amount, 0);

            document.querySelectorAll('.fee-item-checkbox').forEach(cb => {
                const isPaidHere = editingPaymentGroup.itemKeys.has(cb.dataset.itemKey);
                const isPaidElsewhere = allPayments.some(p => p.studentId === studentId && p.itemKey === cb.dataset.itemKey && p.transactionId !== txnId && p.receiptNo !== grp[0].receiptNo);
                cb.nextElementSibling.classList.remove('month-paid', 'month-editable'); cb.checked = isPaidHere; cb.disabled = isPaidElsewhere;
                if(isPaidHere) { cb.nextElementSibling.classList.add('month-editable'); if(cb.dataset.itemType === 'custom') { const input = cb.closest('.relative').querySelector('.custom-fee-amount-input'); input.value = grp.find(p=>p.itemKey === cb.dataset.itemKey).amount; input.classList.remove('hidden'); } } else if(isPaidElsewhere) { cb.nextElementSibling.classList.add('month-paid'); }
            });
            checkReceiptMandatory();
        };

        const processPaymentSubmit = async (isUpdate) => {
            if(!selectedStudentId) return alert("Select student.");
            const selected = Array.from(document.querySelectorAll('.fee-item-checkbox:checked:not(:disabled)'));
            if(selected.length === 0) return alert("Select fee items.");
            
            const rcptStr = document.getElementById('entry-receipt').value.trim();
            const rcpt = rcptStr ? parseInt(rcptStr) : null;
            
            const isReq = checkReceiptMandatory();
            if(isReq && !rcpt) return alert("Receipt Number is mandatory for the selected fee items.");

            if(rcpt) {
                const isDup = allPayments.some(p => p.receiptNo === rcpt && p.collectedBy === currentUserEmail && (!isUpdate || p.transactionId !== editingPaymentGroup.txnId));
                if(isDup) return alert(`രസീത് നമ്പർ ${rcpt} നിലവിലുണ്ട്! (Duplicate found). ദയവായി വേറൊരു നമ്പർ നൽകുക.`);
            }

            const dt = document.getElementById('entry-date').value, tot = parseFloat(document.getElementById('total-amount').value), desc = document.getElementById('entry-description').value.trim();
            if(!dt || isNaN(tot)) return alert("Check Date and Amount.");

            const confirmBtn = document.getElementById('confirm-ok');
            document.getElementById('confirm-title').textContent = isUpdate ? 'Update Payment' : 'Confirm Payment';
            document.getElementById('confirm-message').innerHTML = `<p class="font-medium text-gray-800">${isUpdate ? 'Confirm update?' : 'Save payment for ' + getStudentById(selectedStudentId).name + '?'}</p><p class="mt-2 text-sm text-gray-500 font-mono">Total: ₹${tot}</p>`;
            document.getElementById('confirm-popup').classList.remove('hidden'); document.getElementById('confirm-popup').classList.add('flex');
            
            confirmBtn.onclick = async () => {
                confirmBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Processing...`; confirmBtn.disabled = true;
                try {
                    const batch = writeBatch(db);
                    const tId = isUpdate ? editingPaymentGroup.txnId : (Date.now().toString() + Math.random().toString(36).substr(2, 5));
                    
                    if(isUpdate) { 
                        (await getDocs(query(collection(db, `${BASE_PATH}/payments`), where("transactionId", "==", editingPaymentGroup.txnId)))).forEach(d => batch.delete(d.ref)); 
                        if(editingPaymentGroup.txnId.length < 10) (await getDocs(query(collection(db, `${BASE_PATH}/payments`), where("receiptNo", "==", parseInt(editingPaymentGroup.txnId))))).forEach(d => batch.delete(d.ref));
                    }
                    
                    let customTot = 0; 
                    const customCbs = selected.filter(cb=>cb.dataset.itemType==='custom');
                    const monthlyCbs = selected.filter(cb=>cb.dataset.itemType==='month');

                    customCbs.forEach(cb => { const amt = parseFloat(cb.closest('.relative').querySelector('.custom-fee-amount-input').value) || 0; customTot += amt; });

                    const currentStaffName = isCurrentAdmin ? 'Administrator' : (allStaff.find(s=>s.email===currentUserEmail)?.name || currentUserEmail);
                    const common = { receiptNo: rcpt, transactionId: tId, paymentDate: dt, timestamp: Date.now(), description: desc, collectedBy: currentUserEmail, collectedByName: currentStaffName };
                    
                    if (monthlyCbs.length > 0) {
                        const amtPer = Math.max(0, (tot - customTot) / monthlyCbs.length);
                        customCbs.forEach(cb => { 
                            const amt = parseFloat(cb.closest('.relative').querySelector('.custom-fee-amount-input').value) || 0; 
                            batch.set(doc(collection(db, `${BASE_PATH}/payments`)), { ...common, studentId: selectedStudentId, itemKey: cb.dataset.itemKey, amount: amt }); 
                        });
                        monthlyCbs.forEach(cb => { 
                            const group = studentGroups.find(g => g.memberIds.includes(selectedStudentId));
                            const targetIds = group ? group.memberIds : [selectedStudentId];
                            targetIds.forEach(id => { batch.set(doc(collection(db, `${BASE_PATH}/payments`)), { ...common, studentId: id, itemKey: cb.dataset.itemKey, amount: amtPer }); }); 
                        });
                    } else {
                        let remainingOverride = tot - customTot;
                        customCbs.forEach((cb, index) => { 
                            let amt = parseFloat(cb.closest('.relative').querySelector('.custom-fee-amount-input').value) || 0; 
                            if (index === 0 && remainingOverride !== 0) { amt += remainingOverride; }
                            batch.set(doc(collection(db, `${BASE_PATH}/payments`)), { ...common, studentId: selectedStudentId, itemKey: cb.dataset.itemKey, amount: amt }); 
                        });
                    }

                    await batch.commit(); 
                    if(!isUpdate) document.getElementById('entry-receipt').value = rcpt ? rcpt + 1 : '';
                    exitEditMode();
                } catch (e) { console.error(e); alert("Failed."); }
                finally { confirmBtn.disabled = false; confirmBtn.textContent = 'OK'; document.getElementById('confirm-popup').classList.add('hidden'); }
            };
        };

        document.getElementById('save-fee-btn').addEventListener('click', () => processPaymentSubmit(false));
        document.getElementById('update-fee-btn').addEventListener('click', () => processPaymentSubmit(true));

        // --- FEE STATUS RENDER ---
        const renderFeeTable = () => {
            const fCls = document.getElementById('filter-class').value, fGen = document.getElementById('filter-gender').value, cont = document.getElementById('fee-table-container');
            let list = students.filter(s => (fCls==='all'||s.class===fCls) && (fGen==='all'||s.gender===fGen));
            if(list.length === 0) { cont.innerHTML = `<p class="text-gray-500 text-center py-6">No data found.</p>`; return; }

            const items = feeItems.filter(i => i.isVisible !== false);
            if (items.length === 0) { cont.innerHTML = `<p class="text-gray-500 text-center py-6">No fee items configured.</p>`; return; }

            let html = `<table class="w-full text-sm text-left whitespace-nowrap"><thead class="table-header"><tr><th class="p-3">Adm.No</th><th class="p-3">Student Name</th>${items.map(i=>`<th class="p-3">${i.name}</th>`).join('')}</tr></thead><tbody class="divide-y divide-gray-200">`;
            
            Object.values(list.reduce((acc, s) => { 
                const k=`${s.class}#${s.gender}`; 
                if (!acc[k]) acc[k] = { class: s.class, gender: s.gender, students: [] }; 
                acc[k].students.push(s); 
                return acc; 
            }, {}))
            .sort((a,b) => {
                const classCompare = a.class.localeCompare(b.class, undefined, {numeric: true});
                if (classCompare !== 0) return classCompare;
                if (a.gender === 'Male' && b.gender !== 'Male') return -1;
                if (a.gender !== 'Male' && b.gender === 'Male') return 1;
                return 0;
            })
            .forEach(g => {
                html += `<tr class="bg-gray-100 font-bold text-gray-800"><td colspan="${items.length+2}" class="p-3">${g.class} - ${g.gender}</td></tr>`;
                
                g.students.sort((a,b) => (a.adm||'').localeCompare(b.adm||'', undefined, {numeric: true})).forEach(s => {
                    html += `<tr class="hover:bg-gray-50 bg-white"><td class="p-3 font-mono text-gray-500">${s.adm || '-'}</td><td class="p-3 font-medium text-gray-900 border-r">${s.name}</td>`;
                    items.forEach(i => {
                        const p = allPayments.find(pay => pay.studentId === s.id && pay.itemKey === i.key);
                        if(p) {
                            const staffName = getStaffName(p.collectedBy, p.collectedByName);
                            html += `<td class="p-2 text-center bg-green-50 border-r">
                                <div class="${i.type==='custom'?'text-sm':'text-xs'} font-bold text-green-800">${i.type==='custom'?`₹${p.amount.toFixed(0)}`:(p.receiptNo?`R:${p.receiptNo}`:'Paid')}</div>
                                <div class="text-[10px] text-green-600">${new Date(p.paymentDate).toLocaleDateString('en-GB')}</div>
                                <div class="text-[9px] text-gray-500 font-semibold mt-1 max-w-[80px] truncate mx-auto" title="${staffName}">By: ${staffName}</div>
                            </td>`;
                        } else {
                            html += `<td class="p-3 text-center text-gray-300 border-r">-</td>`;
                        }
                    });
                    html += `</tr>`;
                });
            });
            cont.innerHTML = html + `</tbody></table>`;
        };

        // --- HISTORY RENDER ---
        const updateHistoryStaffFilter = () => {
            const filterEl = document.getElementById('history-staff-filter');
            if (!isCurrentAdmin) { filterEl.classList.add('hidden'); return; }
            filterEl.classList.remove('hidden');
            
            const uniqueEmails = [...new Set(allPayments.map(p => p.collectedBy))].filter(Boolean);
            const currentVal = filterEl.value;
            
            let opts = `<option value="all">All Staff Collections</option>`;
            uniqueEmails.forEach(email => { opts += `<option value="${email}">${getStaffName(email, null)}</option>`; });
            
            filterEl.innerHTML = opts;
            if(uniqueEmails.includes(currentVal) || currentVal === 'all') filterEl.value = currentVal;
        };

        const prepareHistoryData = () => {
            let myPays = getVisiblePayments();
            
            if (isCurrentAdmin) {
                const staffFilter = document.getElementById('history-staff-filter').value;
                if (staffFilter && staffFilter !== 'all') {
                    myPays = myPays.filter(p => p.collectedBy === staffFilter);
                }
            }

            const searchTerm = document.getElementById('history-search-input').value.toLowerCase();

            sortedHistoryList = Object.values(myPays.reduce((a, p) => { 
                const k = p.transactionId || p.receiptNo.toString(); 
                if(!a[k]) a[k] = { 
                    tId: k, r: p.receiptNo||'-', sId: p.studentId, dt: p.paymentDate, 
                    ts: p.timestamp || new Date(p.paymentDate).getTime(), 
                    i: [], tot: 0, by: getStaffName(p.collectedBy, p.collectedByName) 
                }; 
                a[k].i.push(p.itemKey); a[k].tot += p.amount; return a; 
            }, {}));

            if (searchTerm) {
                sortedHistoryList = sortedHistoryList.filter(item => {
                    const s = getStudentById(item.sId);
                    const sName = s ? s.name.toLowerCase() : '';
                    const sAdm = s && s.adm ? s.adm.toLowerCase() : '';
                    const rNo = item.r.toString().toLowerCase();
                    return sName.includes(searchTerm) || sAdm.includes(searchTerm) || rNo.includes(searchTerm);
                });
            }

            sortedHistoryList.sort((a,b) => b.ts - a.ts); // Latest first
            
            document.getElementById('history-count-badge').textContent = `${sortedHistoryList.length} Transactions`;
            const tbody = document.getElementById('history-content-tbody');
            if(sortedHistoryList.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-gray-500">No payment history found.</td></tr>`;
                return; 
            }
            tbody.innerHTML = '';
            historyDisplayedCount = 0;
            loadMoreHistory();
        };

        document.getElementById('history-staff-filter').addEventListener('change', prepareHistoryData);
        document.getElementById('history-search-input').addEventListener('input', prepareHistoryData);

        const loadMoreHistory = () => {
            if(historyDisplayedCount >= sortedHistoryList.length) return;
            
            const limit = historyDisplayedCount === 0 ? INITIAL_LOAD : LOAD_MORE;
            const toAdd = sortedHistoryList.slice(historyDisplayedCount, historyDisplayedCount + limit);
            const tbody = document.getElementById('history-content-tbody');
            const loader = document.getElementById('history-loading-indicator');
            
            loader.classList.remove('hidden');

            setTimeout(() => {
                let html = '';
                toAdd.forEach(i => {
                    const s = getStudentById(i.sId); if(!s) return;
                    html += `<tr class="bg-white hover:bg-gray-50 transition">
                        <td class="p-3 font-medium text-gray-900">${i.r}</td>
                        <td class="p-3 text-gray-600">${new Date(i.dt).toLocaleDateString('en-GB')}</td>
                        <td class="p-3 font-medium text-blue-700">${s.name} <span class="text-xs text-gray-500"><br>(Adm: ${s.adm||'-'})</span></td>
                        <td class="p-3"><span class="text-[10px] font-bold uppercase tracking-wider bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 whitespace-nowrap">${i.by}</span></td>
                        <td class="p-3 text-center text-gray-600">${i.i.length}</td>
                        <td class="p-3 font-bold text-gray-800">₹${i.tot}</td>
                        <td class="p-3 text-center"><button class="edit-payment-btn text-blue-500 hover:text-blue-700 mr-3" data-sid="${i.sId}" data-tid="${i.tId}"><i class="fas fa-edit"></i></button><button class="delete-payment-btn text-red-500 hover:text-red-700" data-sid="${i.sId}" data-tid="${i.tId}"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
                tbody.insertAdjacentHTML('beforeend', html);
                historyDisplayedCount += toAdd.length;
                loader.classList.add('hidden');
            }, 300);
        };

        document.getElementById('history-content-container').addEventListener('scroll', function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 20) {
                if (historyDisplayedCount < sortedHistoryList.length) { loadMoreHistory(); }
            }
        });

        document.getElementById('history-content-container').addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-payment-btn'), delBtn = e.target.closest('.delete-payment-btn');
            if(editBtn) startEditingPayment(editBtn.dataset.sid, editBtn.dataset.tid);
            if(delBtn) {
                const tid = delBtn.dataset.tid; document.getElementById('confirm-title').textContent = "Delete Payment"; document.getElementById('confirm-message').innerHTML = `<p class="text-gray-800 font-medium">Delete this transaction entirely?</p>`; document.getElementById('confirm-popup').classList.remove('hidden'); document.getElementById('confirm-popup').classList.add('flex');
                document.getElementById('confirm-ok').onclick = async () => { 
                    const batch = writeBatch(db);
                    const q1 = query(collection(db, `${BASE_PATH}/payments`), where("transactionId", "==", tid));
                    (await getDocs(q1)).forEach(d=>batch.delete(d.ref));
                    if(tid.length < 10) (await getDocs(query(collection(db, `${BASE_PATH}/payments`), where("receiptNo", "==", parseInt(tid))))).forEach(d=>batch.delete(d.ref));
                    await batch.commit(); document.getElementById('confirm-popup').classList.add('hidden'); 
                }
            }
        });

        // --- MONTHLY REPORT RENDER ---
        const renderMonthlyCollectedPage = (searchTerm = '') => {
            const cont = document.getElementById('monthly-collected-container'), lowerTerm = searchTerm.toLowerCase(); cont.innerHTML = '';
            const myPays = getVisiblePayments();
            
            if (searchTerm) {
                const matching = students.filter(s => s.name.toLowerCase().includes(lowerTerm) || (s.adm && s.adm.toLowerCase().includes(lowerTerm)));
                if (matching.length === 1) {
                    const s = matching[0], paysByItem = myPays.filter(p => p.studentId === s.id).reduce((acc, p) => { acc[p.itemKey] = p; return acc; }, {});
                    let reportText = `NAME   : ${s.name.toUpperCase()}\nCLASS  : ${s.class}\nADM NO : ${s.adm||'-'}\n`;
                    let mText = '', cText = '';
                    feeItems.forEach(i => { const p = paysByItem[i.key]; if (p) { const rStr = p.receiptNo ? p.receiptNo.toString().padEnd(6,' ') : '-     '; if (i.type === 'month') mText += `RCPT : ${rStr} | ${i.name}\n`; else cText += `RCPT : ${rStr} | ${i.name} (₹${p.amount})\n`; } });
                    if (mText) reportText += `\n--- MONTHS ---\n${mText}`; if (cText) reportText += `\n--- OTHER FEES ---\n${cText}`; if (!mText && !cText) reportText += `\nNo data.\n`;
                    cont.innerHTML = `<div class="report-card whitespace-pre-wrap text-sm md:text-base bg-gray-50 border border-gray-200"><div class="flex justify-between items-start border-b pb-3 mb-3"><h3 class="text-lg font-bold">Student Report</h3><button id="back-to-monthly-view-btn" class="py-1 px-3 bg-gray-200 rounded-lg text-sm font-semibold">Back</button></div><pre class="font-mono">${reportText}</pre></div><div class="mt-5 text-center"><button id="share-whatsapp-btn-monthly" data-share-text="${encodeURIComponent('*Student Payment Report*\n-----------------------\n'+reportText)}" class="inline-flex items-center gap-2 bg-green-500 text-white font-bold py-3 px-6 rounded-xl shadow-md w-full md:w-auto justify-center"><i class="fab fa-whatsapp text-xl"></i> <span>Share</span></button></div>`; return;
                } else if (matching.length > 1) {
                    cont.innerHTML = `<div class="p-4 bg-gray-50 border rounded-xl"><h3 class="font-bold text-lg mb-1">Search Results</h3><p class="text-sm text-gray-500 mb-4">Click to view report</p><ul class="space-y-2">${matching.map(s => `<li><button class="w-full text-left p-3 rounded-lg bg-white border hover:border-blue-400 font-medium monthly-student-select flex justify-between" data-student-name="${s.name}"><span>${s.name} <span class="text-gray-500 text-sm font-normal">(${s.class})</span></span><span class="text-xs text-gray-400 font-mono">Adm: ${s.adm||'-'}</span></button></li>`).join('')}</ul></div>`; return;
                }
            }

            const pays = searchTerm ? myPays.filter(p => { const s = getStudentById(p.studentId); return s && (s.class.toLowerCase().includes(lowerTerm) || (p.receiptNo && p.receiptNo.toString().includes(lowerTerm))); }) : myPays;
            const sortedKeys = Object.keys(pays.reduce((a, p) => { if (p.paymentDate) { const mk = p.paymentDate.substring(0, 7); if (!a[mk]) a[mk] = []; a[mk].push(p); } return a; }, {})).sort().reverse();
            if (sortedKeys.length === 0) { cont.innerHTML = `<p class="text-center text-gray-500 py-6">No data.</p>`; return; }

            const currentMK = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
            sortedKeys.forEach(mk => {
                const monthPays = pays.filter(p => p.paymentDate.substring(0,7) === mk), uTxns = {};
                monthPays.forEach(p => { const tid = p.transactionId || p.receiptNo; if (!uTxns[tid]) { const pt = monthPays.filter(pay => pay.transactionId === tid || pay.receiptNo === tid); let m=0, c=0; pt.forEach(pay => { const it = feeItems.find(fi => fi.key === pay.itemKey); if(it && it.type === 'month') m+=pay.amount; else c+=pay.amount; }); uTxns[tid] = {m, c}; } });
                const mTot = Object.values(uTxns).reduce((s, d) => s + d.m, 0), cTot = Object.values(uTxns).reduce((s, d) => s + d.c, 0);
                const mF = monthPays.filter(p => feeItems.find(fi => fi.key === p.itemKey && fi.type === 'month')), cF = monthPays.filter(p => feeItems.find(fi => fi.key === p.itemKey && fi.type === 'custom'));
                
                // FIXED MONTHLY REPORT TOTAL (Only Monthly fees)
                let html = `<div class="bg-gray-50 border p-4 rounded-xl"><div class="flex justify-between items-center cursor-pointer month-header"><h3 class="text-base font-bold">${new Date(mk.split('-')[0], mk.split('-')[1] - 1).toLocaleString('default', { month: 'long', year: 'numeric' })}</h3><div class="flex items-center gap-4"><span class="font-semibold text-sm bg-white px-3 py-1 rounded-full border shadow-sm">Monthly Fees Total: <span class="text-green-600">₹${mTot.toFixed(0)}</span></span><i class="fas fa-chevron-down month-toggle-icon text-gray-400 ${mk === currentMK ? 'rotate-180' : ''}"></i></div></div><div class="month-details-container overflow-x-auto mt-4 pt-4 border-t ${mk === currentMK ? '' : 'hidden'}">`;
                if (mF.length > 0) html += `<table class="w-full text-sm text-left mb-4 whitespace-nowrap"><thead class="bg-gray-100"><tr><th class="p-2">Rcpt</th><th class="p-2">Student</th><th class="p-2">Amount</th></tr></thead><tbody>` + Object.values(mF.reduce((a, p) => { const k = `${p.transactionId||p.receiptNo}-${p.studentId}`; if (!a[k]) a[k] = { sid: p.studentId, r: p.receiptNo||'-', t: 0 }; a[k].t += p.amount; return a; }, {})).map(d => `<tr class="border-b hover:bg-white"><td class="p-2">${d.r}</td><td class="p-2">${getStudentById(d.sid)?.name||'Unknown'}</td><td class="p-2 font-semibold">₹${d.t.toFixed(0)}</td></tr>`).join('') + `</tbody></table>`;
                if (cF.length > 0) html += `<h4 class="text-sm font-bold mt-4 mb-2 bg-gray-200 inline-block px-3 py-1 rounded-lg">Other Fees</h4><table class="w-full text-sm text-left whitespace-nowrap"><thead class="bg-gray-100"><tr><th class="p-2">Rcpt</th><th class="p-2">Student</th><th class="p-2">Item</th><th class="p-2">Amount</th></tr></thead><tbody>` + cF.map(p => `<tr class="border-b hover:bg-white"><td class="p-2">${p.receiptNo||'-'}</td><td class="p-2">${getStudentById(p.studentId)?.name||'Unknown'}</td><td class="p-2">${feeItems.find(fi => fi.key === p.itemKey)?.name||p.itemKey}</td><td class="p-2 font-semibold">₹${p.amount.toFixed(0)}</td></tr>`).join('') + `</tbody><tfoot class="font-bold border-t"><tr><td colspan="3" class="p-2 text-right">Total</td><td class="p-2 text-green-700">₹${cTot.toFixed(0)}</td></tr></tfoot></table>`;
                cont.innerHTML += html + `</div></div>`;
            });
        };
        document.getElementById('monthly-collected-search-input').addEventListener('input', e => renderMonthlyCollectedPage(e.target.value));
        document.getElementById('monthly-collected-container').addEventListener('click', e => {
            const h = e.target.closest('.month-header'), sel = e.target.closest('.monthly-student-select'), back = e.target.closest('#back-to-monthly-view-btn'), share = e.target.closest('#share-whatsapp-btn-monthly');
            if(h) { h.nextElementSibling.classList.toggle('hidden'); h.querySelector('.month-toggle-icon').classList.toggle('rotate-180'); }
            else if(sel) { document.getElementById('monthly-collected-search-input').value = sel.dataset.studentName; renderMonthlyCollectedPage(sel.dataset.studentName); }
            else if(back) { document.getElementById('monthly-collected-search-input').value = ''; renderMonthlyCollectedPage(''); }
            else if(share) window.open(`https://wa.me/?text=${share.dataset.shareText}`, '_blank');
        });

        // --- STUDENTS INFO RENDER ---
        const renderStudentInfoList = () => {
            const fCls = document.getElementById('stu-info-class').value;
            const fGen = document.getElementById('stu-info-gender').value;
            const sTerm = document.getElementById('stu-info-search').value.toLowerCase();
            const cont = document.getElementById('stu-info-list');
            const emptyState = document.getElementById('stu-info-empty');

            if (!fCls && !sTerm) { 
                emptyState.classList.remove('hidden'); cont.classList.add('hidden'); return;
            }
            emptyState.classList.add('hidden'); cont.classList.remove('hidden');

            const fil = students.filter(s => {
                let match = true;
                if(fCls) match = match && s.class === fCls;
                if(fGen !== 'all') match = match && s.gender === fGen;
                if(sTerm) match = match && (s.name.toLowerCase().includes(sTerm) || (s.adm && s.adm.toLowerCase().includes(sTerm)));
                return match;
            });

            if(fil.length === 0) { cont.innerHTML = '<p class="text-gray-500 p-4 text-center font-medium">No students found.</p>'; return; }
            fil.sort((a, b) => a.name.localeCompare(b.name));

            cont.innerHTML = fil.map(s => `
                <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:border-blue-400 hover:shadow-md transition" onclick="openStudentProfile('${s.id}')">
                    <div>
                        <div class="font-bold text-gray-900 text-lg">${s.name}</div>
                        <div class="text-sm text-gray-500">${s.class} (${s.gender}) | Adm: ${s.adm||'-'}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
        };
        document.getElementById('stu-info-class').addEventListener('change', renderStudentInfoList);
        document.getElementById('stu-info-gender').addEventListener('change', renderStudentInfoList);
        document.getElementById('stu-info-search').addEventListener('input', renderStudentInfoList);

        window.openStudentProfile = (id) => {
            const s = getStudentById(id); if(!s) return;
            document.getElementById('prof-name').textContent = s.name;
            document.getElementById('prof-class').textContent = s.class;
            document.getElementById('prof-gender').textContent = s.gender;
            document.getElementById('prof-adm').textContent = s.adm || '-';
            document.getElementById('prof-uid').textContent = s.uid || '-';
            document.getElementById('prof-father').textContent = s.father || '-';
            document.getElementById('prof-addr').textContent = s.address || '-';
            document.getElementById('prof-conc').textContent = s.concessionFee !== undefined && s.concessionFee !== null ? `₹${s.concessionFee}` : 'None';
            
            const mobCont = document.getElementById('prof-mobile');
            const callBtn = document.getElementById('prof-call-btn');
            if(s.mobile) {
                mobCont.textContent = s.mobile;
                callBtn.href = `tel:${s.mobile}`;
                callBtn.classList.remove('hidden');
                callBtn.classList.add('inline-flex');
            } else {
                mobCont.textContent = 'Not Available';
                callBtn.classList.add('hidden');
                callBtn.classList.remove('inline-flex');
            }

            document.getElementById('student-profile-popup').classList.remove('hidden');
            document.getElementById('student-profile-popup').classList.add('flex');
        };

        // --- PDF DOWNLOAD ---
        document.getElementById('fee-download-pdf-btn').addEventListener('click', () => {
            const fCls = document.getElementById('filter-class').value, fGen = document.getElementById('filter-gender').value;
            let list = students.filter(s => (fCls==='all'||s.class===fCls) && (fGen==='all'||s.gender===fGen));
            const items = [...feeItems].filter(m => m.isVisible !== false), headers = ["Student", ...items.map(m => m.name)], body = [];
            
            Object.values(list.reduce((acc, s) => { 
                const k=`${s.class}#${s.gender}`; 
                if (!acc[k]) acc[k] = { class: s.class, gender: s.gender, students: [] }; 
                acc[k].students.push(s); 
                return acc; 
            }, {}))
            .sort((a,b) => {
                const classCompare = a.class.localeCompare(b.class, undefined, {numeric: true});
                if (classCompare !== 0) return classCompare;
                if (a.gender === 'Male' && b.gender !== 'Male') return -1;
                if (a.gender !== 'Male' && b.gender === 'Male') return 1;
                return 0;
            })
            .forEach(g => {
                body.push([{ content: `${g.class} - ${g.gender}`, colSpan: headers.length, styles: { fontStyle: 'bold', fillColor: '#e5e7eb', textColor: '#1f2937' } }]);
                g.students.sort((a,b) => (a.adm||'').localeCompare(b.adm||'', undefined, {numeric: true})).forEach(s => {
                    const row = [`${s.name} (${s.adm||'-'})`];
                    items.forEach(i => { const p = allPayments.find(pay => pay.studentId === s.id && pay.itemKey === i.key); if(p) row.push({ content: i.type==='custom' ? `${p.amount.toFixed(0)}` : (p.receiptNo?`R:${p.receiptNo}`:'Y'), styles: { fillColor: '#ecfdf5', textColor: '#065f46', halign: 'center', fontStyle: 'bold' } }); else row.push({ content: '-', styles: { halign: 'center', textColor: '#9ca3af' } }); });
                    body.push(row);
                });
            });
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
            doc.setFontSize(18); doc.text(feeStatusTitle || "Fee Status Report", 14, 15);
            doc.autoTable({ head: [headers], body: body, startY: 20, theme: 'grid', styles: { fontSize: 8, cellPadding: 1.5, lineColor: '#d1d5db', lineWidth: 0.1 }, headStyles: { fillColor: '#f3f4f6', textColor: '#374151' } });
            doc.save(`${feeStatusTitle || "Fee Status Report"}.pdf`);
        });

        // --- INIT LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            // 🔐 Must be a non-anonymous Firebase user (staff/admin logged in via index.html)
            if (!user || user.isAnonymous) { window.location.href = 'index.html'; return; }
            currentUserEmail = user.email;

            // Check if this user is admin
            try {
                const adminSnap = await getDoc(doc(db, `${BASE_PATH}/settings`, 'adminAuth'));
                if(adminSnap.exists() && adminSnap.data().email === currentUserEmail) {
                    isCurrentAdmin = true;
                    localStorage.setItem('admin_logged_in', 'true');
                } else {
                    isCurrentAdmin = false;
                    localStorage.removeItem('admin_logged_in');
                    // Verify this user is in staff collection (non-admin staff)
                    const staffSnap = await getDocs(collection(db, `${BASE_PATH}/staff`));
                    const myStaff = staffSnap.docs.find(d => d.data().email === currentUserEmail);
                    if (!myStaff) {
                        // Not admin, not in staff collection → redirect
                        window.location.href = 'index.html';
                        return;
                    }
                }
            } catch(e) {
                console.warn("Staff verify warning:", e.message);
                // On Firestore error, Firebase auth being signed in is sufficient
            }

            const displayEl = document.getElementById('staff-name-display');
            if (isCurrentAdmin) { displayEl.textContent = "ADMINISTRATOR"; }

            onSnapshot(collection(db, `${BASE_PATH}/staff`), (snap) => {
                allStaff = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (!isCurrentAdmin) { 
                    const myData = allStaff.find(s => s.email === currentUserEmail);
                    if(myData) { 
                        displayEl.textContent = myData.name; 
                        localStorage.setItem('staff_name', myData.name); 
                    } else { 
                        displayEl.textContent = currentUserEmail; 
                    }
                }
                updateHistoryStaffFilter();
                if(document.getElementById('history-page').classList.contains('hidden') === false) prepareHistoryData();
            });

            const confRef = doc(db, `${BASE_PATH}/settings`, 'config');
            onSnapshot(confRef, (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    
                    const appNameStr = d.appName || 'Fee Collection';
                    document.getElementById('header-title').textContent = appNameStr;
                    setTimeout(() => { fitText('header-title'); }, 50);

                    const regEl = document.getElementById('header-regno');
                    const placeEl = document.getElementById('header-place');
                    const sepEl = document.getElementById('header-sep');
                    const subContainer = document.getElementById('header-subtitle');
                    
                    regEl.textContent = d.regNo ? `Reg: ${d.regNo}` : '';
                    placeEl.textContent = d.place || '';
                    if(d.regNo || d.place) {
                        subContainer.classList.remove('hidden');
                        if(d.regNo && d.place) sepEl.classList.remove('hidden'); else sepEl.classList.add('hidden');
                    } else { subContainer.classList.add('hidden'); }

                    if(d.logoUrl) {
                        document.getElementById('header-logo').src = d.logoUrl;
                        document.getElementById('header-logo').style.opacity = '1';
                    }

                    document.getElementById('footer-inst-name').textContent = appNameStr;
                    
                    const fPhone = document.getElementById('footer-phone');
                    const fPhoneLink = document.getElementById('footer-phone-link');
                    if(fPhone) fPhone.textContent = d.contactPhone || 'Not Available';
                    if(fPhoneLink && d.contactPhone) fPhoneLink.href = `tel:${d.contactPhone}`;

                    const fEmail = document.getElementById('footer-email');
                    const fEmailLink = document.getElementById('footer-email-link');
                    if(fEmail) fEmail.textContent = d.contactEmail || 'Not Available';
                    if(fEmailLink && d.contactEmail) fEmailLink.href = `mailto:${d.contactEmail}`;

                    ['youtube','telegram','instagram','whatsapp','facebook'].forEach(k => {
                        const el = document.getElementById(`link-${k}`);
                        if(el) {
                            const url = k === 'youtube' ? d.socialYouTube : d['social' + k.charAt(0).toUpperCase() + k.slice(1)];
                            if(url) { el.href = url; el.classList.remove('hidden'); }
                            else el.classList.add('hidden');
                        }
                    });

                    defaultFee = d.defaultFee || 200; 
                    feeStatusTitle = d.feeStatusTitle || ''; 
                    feeItems = d.feeItems || [];
                    defaultReceiptMandatory = d.defaultReceiptMandatory || false;
                    
                    const fsh = document.getElementById('fee-status-title-header');
                    if(fsh && feeStatusTitle) fsh.textContent = feeStatusTitle;
                    
                    if(!isEditMode && document.getElementById('home-page').classList.contains('hidden') === false) {
                        setupFeeEntryUI();
                    }
                    if(document.getElementById('fee-page').classList.contains('hidden') === false) {
                        renderFeeTable();
                    }
                }
            });

            onSnapshot(collection(db, `${BASE_PATH}/students`), (snap) => { 
                students = snap.docs.map(d => ({id: d.id, ...d.data()})); 
                populateClassDropdowns(); 
                updateDashboardMetrics();
                if(document.getElementById('fee-page').classList.contains('hidden') === false) renderFeeTable(); 
                if(document.getElementById('students-page').classList.contains('hidden') === false) renderStudentInfoList(); 
            });
            onSnapshot(collection(db, `${BASE_PATH}/studentGroups`), (snap) => { studentGroups = snap.docs.map(d => ({id: d.id, ...d.data()})); });
            
            onSnapshot(collection(db, `${BASE_PATH}/payments`), (snap) => {
                allPayments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboardMetrics();
                updateHistoryStaffFilter();
                
                if(!isEditMode && document.getElementById('home-page').classList.contains('hidden') === false) {
                    if(!document.getElementById('entry-receipt').value) {
                         document.getElementById('entry-receipt').value = getNextReceiptNoForStaff();
                    }
                }

                if(document.getElementById('history-page').classList.contains('hidden') === false) prepareHistoryData();
                if(document.getElementById('monthly-collected-page').classList.contains('hidden') === false) renderMonthlyCollectedPage(document.getElementById('monthly-collected-search-input').value);
                if(document.getElementById('fee-page').classList.contains('hidden') === false) renderFeeTable();
            });
        });

    </script>
</body>
</html>